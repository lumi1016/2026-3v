<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>2025 關西家族之旅 - 旗艦導遊版</title>
    <!-- 桌面圖示：紅色鳥居 -->
    <link rel="apple-touch-icon" href="https://i.ibb.co/27KXyfSt/image.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;700;900&family=Ma+Shan+Zheng&display=swap');
        
        :root {
            --kyoto-red: #B22D15;
            --bamboo-green: #3A4D39;
            --osaka-gold: #D4AF37;
            --washi-bg: #F9F6F0;
            --stay-dark: #1A1A1A;
            --premium-navy: #1E272E;
        }

        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: var(--washi-bg);
            color: #2D3436;
            -webkit-tap-highlight-color: transparent;
            overflow-x: hidden;
            text-align: left;
        }

        .calligraphy { font-family: 'Ma Shan Zheng', cursive !important; }
        .kaity { font-family: 'DFKai-SB', '標楷體', 'Kaiti TC', 'KaiTi', serif !important; }

        .tab-active {
            background: var(--kyoto-red) !important;
            color: white !important;
            box-shadow: 0 8px 20px rgba(178, 45, 21, 0.35);
            transform: scale(1.08);
        }

        .glass-tool {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.6);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }

        .fade-in { animation: fadeIn 0.4s ease-out forwards; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .animate-slideUp { animation: slideUp 0.3s cubic-bezier(0, 0, 0.2, 1) forwards; }
        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }

        .modal-immersive-header {
            height: 320px;
            background-size: cover;
            background-position: center;
            position: relative;
        }

        .modal-immersive-overlay {
            background: linear-gradient(to bottom, rgba(249, 246, 240, 0.1) 0%, rgba(249, 246, 240, 0.9) 100%);
            position: absolute;
            inset: 0;
            z-index: 1;
        }

        .text-shadow-premium {
            text-shadow: 0 0 15px rgba(255, 255, 255, 1), 0 0 5px rgba(255, 255, 255, 0.8);
        }

        .badge-spot { background: #E6F3FF; color: #007AFF; }
        .badge-food { background: #FFF4E6; color: #FF9500; }
        .badge-stay { background: rgba(255, 215, 0, 0.2); color: #FFD700; border: 1px solid rgba(255, 215, 0, 0.3); }
        .badge-check { background: rgba(255, 255, 255, 0.2); color: #FFFFFF; border: 1px solid rgba(255, 255, 255, 0.4); }
        
        .card-stay {
            background-color: var(--stay-dark) !important;
            color: #FFFFFF !important;
            border-left: 6px solid var(--osaka-gold) !important;
        }
        .card-stay h3, .card-stay p { color: #FFFFFF !important; }
        
        .card-check {
            background: var(--premium-navy) !important;
            color: #FFFFFF !important;
            border-left: 6px solid #5758BB !important;
            box-shadow: 0 10px 25px rgba(30, 39, 46, 0.25) !important;
        }
        .card-check h3, .card-check p { color: #FFFFFF !important; }
        .card-check .text-gray-500 { color: #BDC3C7 !important; }
        .card-check .bg-red-50 { background: rgba(255,255,255,0.1) !important; border: 1px solid rgba(255,255,255,0.2) !important; color: white !important; }

        .btn-press:active { transform: scale(0.92); opacity: 0.8; }
        
        #stamina-ring { transition: stroke-dashoffset 1.2s ease-out; }
    </style>
</head>
<body class="max-w-md mx-auto shadow-2xl min-h-screen pb-48 relative">

    <!-- Header Section -->
    <header id="main-header" class="bg-[#3A4D39] text-white p-8 rounded-b-[4rem] shadow-2xl relative overflow-hidden min-h-[220px] flex flex-col justify-end transition-all text-left">
        <img id="header-bg" src="https://images.unsplash.com/photo-1590559899731-a382839e5549?auto=format&fit=crop&w=1200&q=80" class="absolute inset-0 w-full h-full object-cover opacity-45 transition-all duration-700">
        <div class="absolute inset-0 bg-gradient-to-t from-[#3A4D39] via-transparent to-transparent opacity-80"></div>
        <div class="relative z-10 flex justify-between items-end">
            <div class="flex-1 overflow-hidden pb-1 text-left">
                <h1 class="text-4xl font-black kaity text-gray-900 leading-none text-shadow-premium mb-1">關西小醉醉</h1>
                <p class="text-xs font-bold text-yellow-100/80 tracking-widest uppercase">Kansai Luxury Travel 2025</p>
            </div>
            <div class="text-right flex flex-col items-end">
                <p id="weather-city-name" class="text-7xl calligraphy text-yellow-50 leading-none mb-1 drop-shadow-md">--</p>
                <div class="flex items-center justify-end gap-2 pr-1">
                    <span id="weather-icon-inline" class="text-base opacity-90"></span>
                    <p id="weather-temp-calligraphy" class="text-4xl calligraphy text-yellow-100 leading-none">--°C</p>
                </div>
            </div>
        </div>
    </header>

    <!-- Toolbar -->
    <section class="px-4 -mt-10 relative z-20 flex justify-center gap-2 text-center">
        <button onclick="window.toggleTool('calc')" class="w-[23%] glass-tool p-4 rounded-[2rem] shadow-xl flex flex-col items-center btn-press">
            <i class="fas fa-calculator text-[--osaka-gold] mb-1.5 text-xl"></i>
            <span class="text-[9px] font-black text-gray-800">匯率</span>
        </button>
        <button onclick="window.toggleTool('ledger')" class="w-[23%] glass-tool p-4 rounded-[2rem] shadow-xl flex flex-col items-center btn-press">
            <i class="fas fa-coins text-emerald-600 mb-1.5 text-xl"></i>
            <span class="text-[9px] font-black text-gray-800">記帳</span>
        </button>
        <button onclick="window.toggleTool('trans')" class="w-[23%] glass-tool p-4 rounded-[2rem] shadow-xl flex flex-col items-center btn-press">
            <i class="fas fa-language text-blue-500 mb-1.5 text-xl"></i>
            <span class="text-[9px] font-black text-gray-800">翻譯</span>
        </button>
        <button onclick="window.toggleTool('checklist')" class="w-[23%] glass-tool p-4 rounded-[2rem] shadow-xl flex flex-col items-center btn-press">
            <i class="fas fa-clipboard-list text-purple-500 mb-1.5 text-xl"></i>
            <span class="text-[9px] font-black text-gray-800">清單</span>
        </button>
    </section>

    <!-- Navigation -->
    <nav class="flex overflow-x-auto whitespace-nowrap px-4 py-8 no-scrollbar sticky top-0 z-40 bg-[--washi-bg]/95 backdrop-blur-md">
        <div class="flex space-x-4 mx-auto px-4" id="day-nav-container"></div>
    </nav>

    <!-- Main Content -->
    <main id="main-content" class="px-6 min-h-[400px]"></main>

    <!-- Modal Container -->
    <div id="tool-modal" class="hidden fixed inset-0 z-[150] flex items-end justify-center bg-black/60 backdrop-blur-md" onclick="if(event.target === this) window.closeModal()">
        <div class="bg-[--washi-bg] w-full max-w-md rounded-t-[3rem] shadow-2xl overflow-hidden animate-slideUp max-h-[92vh] flex flex-col relative">
            <div class="w-12 h-1 bg-gray-300 rounded-full mx-auto mt-4 mb-2 text-center"></div>
            <!-- 強制置頂的關閉按鈕 -->
            <button onclick="window.closeModal()" class="absolute top-6 right-6 z-[999] w-12 h-12 rounded-full bg-black/20 text-white flex items-center justify-center active:scale-90 shadow-lg backdrop-blur-md border border-white/20">
                <i class="fas fa-times text-xl"></i>
            </button>
            <div id="modal-body" class="flex-1 overflow-y-auto no-scrollbar pb-10 text-left"></div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="fixed bottom-6 left-1/2 -translate-x-1/2 w-[92%] max-w-sm bg-white/95 backdrop-blur-3xl rounded-[2.5rem] shadow-2xl border border-white p-5 z-50 flex justify-between items-center px-10 safe-pb">
        <a href="tel:0901234567" class="flex flex-col items-center">
            <div class="w-12 h-12 rounded-full bg-red-50 text-[--kyoto-red] flex items-center justify-center mb-1 shadow-sm text-center"><i class="fas fa-phone-alt text-xl"></i></div>
            <span class="text-[8px] font-black text-gray-500 uppercase tracking-tighter text-center">聯繫司機</span>
        </a>
        <div class="text-center relative -top-2">
            <div class="relative w-16 h-16 mx-auto">
                <svg class="w-full h-full transform -rotate-90">
                    <circle cx="32" cy="32" r="28" stroke="#f0f0f0" stroke-width="4" fill="transparent" />
                    <circle id="stamina-ring" cx="32" cy="32" r="28" stroke="var(--kyoto-red)" stroke-width="4" fill="transparent" stroke-dasharray="176" stroke-dashoffset="176" />
                </svg>
                <div class="absolute inset-0 flex items-center justify-center font-black text-[--kyoto-red] text-sm text-center"><span id="stamina-val">--%</span></div>
            </div>
            <span class="text-[8px] font-black text-gray-400 uppercase tracking-widest text-center">家族體力</span>
        </div>
        <button onclick="window.toggleTool('trans')" class="flex flex-col items-center">
            <div class="w-12 h-12 rounded-full bg-blue-50 text-blue-600 flex items-center justify-center mb-1 shadow-sm font-black text-center"><i class="fas fa-robot text-xl"></i></div>
            <span class="text-[8px] font-black text-gray-500 uppercase tracking-tighter text-center">AI 助手</span>
        </button>
    </footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, onSnapshot, addDoc, deleteDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const apiKey = ""; 

        // 1. 全局行程資料庫 (穩定閉合版 - 使用反引號確保閉合)
        const tourData = {
            1: { 
                label: "Day 1 大阪・美食強攻", loc: "大阪", engLoc: "Osaka", img: "https://images.unsplash.com/photo-1590559899731-a382839e5549?auto=format&fit=crop&w=1200&q=80", stamina: 85, 
                events: [
                    { t: "09:20", s: "桃園機場 | 星宇 JX822", type: "交通", i: "plane-departure", n: "啟航關西。享受機上精品設施。", m: "Taoyuan+Airport", imgDetail: "https://images.unsplash.com/photo-1530521954074-e64f6810b32d?auto=format&fit=crop&w=800", detailTitle: "星宇 JX822 啟航", intro: `建議 06:50 抵達辦理登機。機上螢幕豐富，推薦體驗精緻精品餐飲。`, aiGuide: `首席導遊：機上胡同燒肉飯極受好評。若有素食需求請確認預訂「東方素食餐」。`, mustEat: "胡同燒肉機上餐。" },
                    { t: "15:30", s: "頂級和牛：Mouriya 神戶牛", type: "餐廳", i: "fire", n: "震撼開場：極品和牛排。", m: "Mouriya+Osaka", imgDetail: "https://images.unsplash.com/photo-1544025162-d76694265947?auto=format&fit=crop&w=800", detailTitle: "極品神戶和牛", intro: `環境優雅靜謐。老師傅現場料理，油脂入口即化，嚼起來毫無負擔。`, aiGuide: `首席導遊：建議 Medium 熟度配上海鹽，油脂入口即化。`, reserved: true, vegNote: `提供野菜鐵板燒套組。` },
                    { t: "20:30", s: "入住：MIMARU大阪 心斎橋NORTH", type: "住宿", i: "hotel", n: "地址：〒542-0081 大阪府中央區南船場2-4-18", m: "MIMARU+Osaka+Shinsaibashi+North", imgDetail: "https://i.ibb.co/Wv8V9WDM/image.jpg", detailTitle: "心齋橋精緻寓所", intro: `備有廚房與大餐桌。電話：6435282209。`, website: "https://mimaruhotels.com/zh/hotel/shinsaibashi-north/", reserved: true }
                ] 
            },
            2: { 
                label: "Day 2 影城・尊榮狂歡", loc: "大阪", engLoc: "Osaka", img: "https://i.ibb.co/Fb2MnJ7h/image.jpg", stamina: 40, 
                events: [
                    { t: "07:30", s: "大阪環球：出發前確認清單", type: "檢查", i: "clipboard-check", n: "長輩安心包最後確認。", m: "USJ", imgDetail: "https://images.unsplash.com/photo-1590233461421-47701389772d?auto=format&fit=crop&w=800", detailTitle: "VIP 影城必備清單", intro: `出發前請確認：<br>✅ **VIP 憑證 QR**：最重要。<br>✅ **門票 & 護照**：APP 內確認。<br>✅ **行動電源**：拍照耗電多。<br>✅ **外套 / 雨衣**：防濺水。`, aiGuide: `首席導遊：這張卡片最重要，請長輩檢查完證件再上車。` },
                    { t: "08:00", s: "VIP 專屬入口報到", type: "體驗", i: "crown", n: "準時抵達，尊榮之旅啟程。", m: "USJ+VIP+Entrance", imgDetail: "https://images.unsplash.com/photo-1590233461421-47701389772d?auto=format&fit=crop&w=800", detailTitle: "VIP 豪華休息室", intro: `建議司機在「飯店接送區 (Bus/Taxi Drop-off)」下車，此處離 VIP 入口最近。`, aiGuide: `導遊攻略：報到領取 VIP 頸鍊。導覽開始前先上洗手間，休息室設施最舒適。`, reserved: true },
                    { t: "09:30", s: "VIP 3 小時精華導覽", type: "景點", i: "star", n: "免排隊深入瑪利歐與大白鯊。", m: "Super+Nintendo+World", imgDetail: "https://images.unsplash.com/photo-1624316812891-b3b3a6230919?auto=format&fit=crop&w=1200", detailTitle: "免排隊導覽體驗", intro: `專人帶領體驗：瑪利歐賽車、大金剛礦車、耀西冒險與大白鯊船旅。`, aiGuide: `導遊推薦：耀西冒險平緩，是拍瑪利歐全景最好的位置。大白鯊體力負擔極低。`, accessible: true },
                    { t: "12:30", s: "優雅午餐：Parkside Grill", type: "美食", i: "utensils", n: "熟成牛排與桌邊服務。", m: "Parkside+Grill", imgDetail: "https://images.unsplash.com/photo-1544025162-d76694265947?auto=format&fit=crop&w=800", detailTitle: "湖畔奢華午饗", intro: `餐廳面向潟湖，採光極佳且環境寬敞。提供完整的**「桌邊服務」**，完全不用端托盤排隊找位。`, aiGuide: `VIP 享 10% 折扣。牛排肉質極軟，適合長輩。`, vegNote: `提供季節蔬食義大利麵。` },
                    { t: "14:00", s: "4 張快通設施詳細解析", type: "體驗", i: "ticket-alt", n: "哈利波特、柯南 4D 詳細解析。", m: "The+Wizarding+World+of+Harry+Potter", imgDetail: "https://images.unsplash.com/photo-1590233461421-47701389772d?auto=format&fit=crop&w=800", detailTitle: "快通攻略", intro: `1. **名偵探柯南 4D (強推！)**：劇場坐著休息看特效。<br>2. **哈利波特禁忌之旅**：怕暈可只走「城堡參觀通道」。<br>3. **小小兵**：可愛動態座席。<br>4. **鷹頭馬身獸**：較溫和雲霄飛車。`, aiGuide: `導遊叮嚀：快通是實體券，直接交給入口工作人員即可。`, reserved: true },
                    { t: "18:30", s: "晚餐：芬尼根酒吧餐廳", type: "美食", i: "beer", n: "復古愛爾蘭主題，舒適沙發座。", m: "Finnegans+Bar", imgDetail: "https://images.unsplash.com/photo-1555396273-367ea4eb4db5?auto=format&fit=crop&w=800", detailTitle: "愛爾蘭樂饗", intro: `料理：愛爾蘭風味、炸魚薯條、牛排。雖然是酒吧主題，但晚餐環境非常舒適。`, aiGuide: `導遊觀點：這裡有很多**舒適沙發座**，氣氛輕鬆適合聊天。`, vegNote: `必點「炸洋蔥花」。` },
                    { t: "20:30", s: "返回飯店休息", type: "住宿", i: "hotel", n: "MIMARU大阪 心斎橋NORTH", m: "MIMARU+Osaka+Shinsaibashi+North", imgDetail: "https://i.ibb.co/Wv8V9WDM/image.jpg", detailTitle: "回到溫馨寓所" }
                ] 
            },
            3: { 
                label: "Day 3 奈良・神鹿文化", loc: "奈良", engLoc: "Nara", img: "https://i.ibb.co/Rp5Zt2vJ/image.jpg", stamina: 70, 
                events: [
                    { t: "10:30", s: "奈良大佛參拜", type: "景點", i: "hippo", n: "餵鹿與參拜大佛。", m: "Todaiji", imgDetail: "https://i.ibb.co/ksgDLctq/image.jpg", detailTitle: "奈良大佛", accessible: true },
                    { t: "13:00", s: "午餐：志津香釜飯", type: "美食", i: "utensils", n: "百年現煮釜飯名店。", m: "Shizuka", imgDetail: "https://i.ibb.co/hRXB7hKW/image.jpg", detailTitle: "奈良名味", vegNote: `有野菜釜飯。` },
                    { t: "18:00", s: "入住：22 pieces (京都)", type: "住宿", i: "hotel", n: "地址：京都府南區東九條室町9-4", m: "22+pieces+Kyoto", imgDetail: "https://i.ibb.co/svMxj7z5/image.jpg", detailTitle: "京都車站泊", website: "https://22-pieces.hotels-in-kyoto.com/en/#photo", reserved: true }
                ] 
            },
            4: { label: "Day 4 京都・散策", loc: "京都", engLoc: "Kyoto", img: "https://i.ibb.co/PzY0SDLD/image.jpg", stamina: 65, events: [{ t: "09:30", s: "清水寺參拜", type: "景點", i: "torii-gate", n: "清水舞台。", m: "Kiyomizu", imgDetail: "https://i.ibb.co/8nLR731B/image.jpg", detailTitle: "清水舞台" }] },
            5: { label: "Day 5 嵐山・遊船", loc: "京都", engLoc: "Kyoto", img: "https://i.ibb.co/JFxL6W1q/image.jpg", stamina: 75, events: [{ t: "10:00", s: "嵐山小火車", type: "交通", i: "train", n: "溪谷觀光。", m: "Kameoka", imgDetail: "https://images.unsplash.com/photo-1545569341-9eb8b30979d9?auto=format&fit=crop&w=800", detailTitle: "觀光小火車" }] },
            6: { label: "Day 6 賦歸", loc: "京都", engLoc: "Kyoto", img: "https://i.ibb.co/ccRs1FZB/image.jpg", stamina: 95, events: [{ t: "14:00", s: "關西機場起飛", type: "交通", i: "plane-departure", n: "返抵桃園。", m: "KIX", imgDetail: "https://images.unsplash.com/photo-1436491865332-7a61a109c0f3?auto=format&fit=crop&w=800", detailTitle: "平安返台" }] }
        };

        // 2. 狀態與核心邏輯
        let user = null, expenses = [], exchangeRate = 0.211;

        window.closeModal = () => {
            const modal = document.getElementById('tool-modal');
            if (modal) modal.classList.add('hidden');
        };

        window.toggleTool = (type, day, idx) => {
            const modal = document.getElementById('tool-modal'), body = document.getElementById('modal-body');
            if (!modal || !body) return;
            modal.classList.remove('hidden');
            body.innerHTML = '<div class="p-20 text-center"><i class="fas fa-circle-notch fa-spin text-4xl mb-4"></i><p>資深導遊努力加載中...</p></div>';
            
            setTimeout(() => {
                if (type === 'calc') {
                    body.innerHTML = `<div class="p-10 text-left fade-in"><h3 class="text-3xl font-black kaity mb-6 text-left">匯率換算</h3><div class="mb-6 bg-yellow-50 p-6 rounded-3xl border border-yellow-100"><p class="text-xl font-bold font-mono">${window.liveRateText || '1 JPY = 0.211 TWD'}</p></div><div class="mb-8"><label class="text-[11px] font-black text-gray-400 block mb-2 font-mono">日圓 (JPY)</label><input type="number" id="jpy-input" class="w-full text-5xl font-black border-b-4 border-[--osaka-gold] py-4 outline-none bg-transparent" oninput="window.runConversion()" placeholder="¥"></div><div><label class="text-[11px] font-black text-gray-400 block mb-2 font-mono">台幣 (TWD)</label><p id="twd-output" class="text-6xl font-black text-[--kyoto-red] mt-2">0</p></div></div>`;
                } else if (type === 'ledger') {
                    body.innerHTML = `<div class="p-8 text-left fade-in"><h3 class="text-3xl font-black kaity mb-6">家族記帳</h3><div class="bg-emerald-600 p-8 rounded-[2.5rem] shadow-xl text-white mb-8 text-center"><p class="text-emerald-100 text-xs mb-1 font-mono">分攤總計 (8位)</p><p id="ledger-total-jpy" class="text-4xl font-black font-mono">¥ 0</p></div><div class="flex gap-3 mb-8"><input type="text" id="ledger-item-name" placeholder="品項" class="flex-1 bg-white rounded-2xl p-4 outline-none border border-gray-100"><input type="number" id="ledger-item-amount" placeholder="¥" class="w-24 bg-white rounded-2xl p-4 outline-none border border-gray-100 font-mono"><button onclick="window.addExpense()" class="bg-emerald-600 text-white w-14 rounded-2xl flex items-center justify-center btn-press"><i class="fas fa-plus"></i></button></div><div id="ledger-list" class="space-y-4 mb-8"></div><div class="mt-10 pt-8 border-t border-gray-100"><a href="https://liff.line.me/1655320992-Y8GowEpw/g/2jGf3BAwhK1jsbnwmPN7BQ" target="_blank" class="block w-full py-5 bg-[#06C755] text-white rounded-[2rem] text-center text-sm font-black shadow-lg btn-press flex items-center justify-center gap-3"><i class="fab fa-line text-2xl"></i>開啟分帳群組</a></div></div>`;
                    renderLedger();
                } else if (type === 'checklist') {
                    body.innerHTML = `<div class="p-10 text-left fade-in"><h3 class="text-3xl font-black kaity mb-6">行前清單</h3><div class="space-y-4">${["護照", "網卡", "日幣", "VIP憑證", "行動電源", "保暖衣物"].map(t => `<label class="flex items-center gap-4 bg-white p-5 rounded-2xl border shadow-sm"><input type="checkbox" class="w-6 h-6 text-[--kyoto-red]"><span class="text-sm font-bold text-gray-700">${t}</span></label>`).join('')}</div></div>`;
                } else if (type === 'detail') {
                    const d = tourData[day].events[idx];
                    body.innerHTML = `<div class="fade-in"><div class="modal-immersive-header" style="background-image: url('${d.imgDetail}')"><div class="modal-immersive-overlay"></div><div class="absolute bottom-8 left-10 right-10 z-10 text-left"><span class="badge-spot text-[10px] px-5 py-2 rounded-full font-black mb-3 inline-block shadow-sm">${d.type}</span><h2 class="text-4xl font-black text-gray-900 kaity text-shadow-premium leading-tight">${d.detailTitle}</h2></div></div><div class="px-10 pb-16 pt-8 space-y-10 text-left"><section><h4 class="text-2xl font-black kaity border-l-4 border-[--kyoto-red] pl-4 mb-3">詳細介紹</h4><p class="text-[15px] leading-relaxed text-gray-600 font-medium">${d.intro}</p></section><section class="bg-white p-7 rounded-[2.5rem] border border-gray-100 shadow-sm"><h4 class="text-xl font-black kaity text-[--kyoto-red] mb-3"><i class="fas fa-user-tie mr-2"></i>資深導遊觀點</h4><p class="text-[14px] font-bold italic text-gray-700">${d.aiGuide || '首席導遊：祝您旅程愉快。'}</p></section>${d.vegNote ? `<section class="bg-emerald-50 p-7 rounded-[2.5rem] border border-emerald-100"><h4 class="text-xl font-black kaity text-emerald-700 mb-2"><i class="fas fa-leaf mr-2"></i>蔬食導航</h4><p class="text-[14px] font-bold text-emerald-800">${d.vegNote}</p></section>` : ''}${d.website ? `<a href="${d.website}" target="_blank" class="block w-full py-5 bg-blue-600 text-white rounded-[2rem] text-center text-lg font-black kaity shadow-xl btn-press"><i class="fas fa-external-link-alt mr-2"></i>開啟官網</a>` : ''}<a href="https://www.google.com/maps/search/?api=1&query=${d.m}" target="_blank" class="block w-full py-5 bg-gray-900 text-white rounded-[2rem] text-center text-lg font-black kaity shadow-xl btn-press">開啟 Google 地圖</a></div></div>`;
                }
            }, 50);
        };

        window.runConversion = () => {
            const jpy = document.getElementById('jpy-input')?.value, output = document.getElementById('twd-output');
            if (output && jpy) output.innerText = (parseFloat(jpy) * exchangeRate).toLocaleString('zh-TW', {maximumFractionDigits: 1});
        };

        async function updateWeatherUI(city, eng) {
            const coords = eng === "Osaka" ? "latitude=34.69&longitude=135.50" : "latitude=35.01&longitude=135.77";
            try {
                const res = await fetch(`https://api.open-meteo.com/v1/forecast?${coords}&current_weather=true`);
                if (!res.ok) return;
                const d = await res.json(), temp = Math.round(d.current_weather.temperature), code = d.current_weather.weathercode;
                let icon = code >= 51 ? "fa-cloud-showers-heavy" : (code >= 1 ? "fa-cloud-sun" : "fa-sun");
                document.getElementById('weather-city-name').innerText = city;
                document.getElementById('weather-icon-inline').innerHTML = `<i class="fas ${icon}"></i>`;
                document.getElementById('weather-temp-calligraphy').innerText = `${temp}°C`;
            } catch (e) {}
        }

        window.switchDay = (d) => {
            const data = tourData[d]; if (!data) return;
            document.querySelectorAll('#day-nav-container button').forEach(b => b.classList.remove('tab-active'));
            document.getElementById(`tab${d}`).classList.add('tab-active');
            document.getElementById('header-bg').src = data.img;
            const ring = document.getElementById('stamina-ring'), dash = 176 - (176 * (data.stamina || 100) / 100);
            ring.style.strokeDashoffset = dash; document.getElementById('stamina-val').innerText = (data.stamina || 100) + '%';

            let html = `<div class="fade-in space-y-6">`;
            data.events.forEach((e, idx) => {
                let isStay = e.type === '住宿', isCheck = e.type === '檢查';
                let badgeClass = isStay ? 'badge-stay' : (isCheck ? 'badge-check' : (e.type === '美食' || e.type === '餐廳' || e.type === '體驗' ? 'badge-food' : 'badge-spot'));
                let cardClass = isStay ? 'card-stay shadow-lg' : (isCheck ? 'card-check shadow-lg' : 'bg-white shadow-sm border border-gray-100');
                let subTitleText = isStay ? '查看飯店特色與周邊景點' : '查看細節與美食攻略';
                html += `<div class="relative pl-8 mb-8 border-l-2 border-dashed border-gray-200 text-left" onclick="window.toggleTool('detail', ${d}, ${idx})"><div class="absolute -left-2 top-0 w-4 h-4 rounded-full ${isStay ? 'bg-[--osaka-gold]' : (isCheck ? 'bg-[#BEB7FF]' : 'bg-[--kyoto-red]')} border-4 border-white shadow-md"></div><div class="${cardClass} rounded-[2.5rem] p-7 active:scale-[0.97] transition-all text-left"><div class="flex justify-between items-center mb-4"><span class="${isStay ? 'bg-amber-600' : (isCheck ? 'bg-indigo-900/30' : 'bg-[--bamboo-green]')} text-white text-[9px] px-3 py-1 rounded-full font-bold shadow-sm">${e.t}</span><div class="flex gap-2">${e.reserved ? `<span class="bg-amber-100 text-amber-600 text-[8px] font-black px-2 py-1 rounded-lg border border-amber-200">預約</span>` : ''}<span class="${badgeClass} text-[8px] font-black px-2.5 py-1 rounded-lg">${e.type}</span></div></div><h3 class="text-xl font-bold mb-2 kaity flex items-center"><i class="fas fa-${e.i || 'map-marker-alt'} mr-3 ${isStay ? 'text-[--osaka-gold]' : (isCheck ? 'text-white' : 'text-[--kyoto-red]')} text-lg opacity-80"></i>${e.s}</h3><p class="text-xs font-bold mb-4 line-clamp-1 opacity-80">${e.n}</p><div class="${isStay || isCheck ? 'bg-white/10' : 'bg-red-50'} px-4 py-2.5 rounded-2xl text-[10px] font-black border border-white/20 flex items-center justify-between"><span><i class="fas fa-eye mr-2"></i>${subTitleText}</span><i class="fas fa-chevron-right text-[8px] opacity-40"></i></div></div></div>`;
            });
            document.getElementById('main-content').innerHTML = html + `</div>`;
            updateWeatherUI(data.loc, data.engLoc); window.scrollTo({ top: 0, behavior: 'smooth' });
        };

        window.addExpense = async () => {
            const n = document.getElementById('ledger-item-name')?.value, a = parseFloat(document.getElementById('ledger-item-amount')?.value);
            if (!user || !n || isNaN(a)) return;
            try {
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'kansai-pro-2025';
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'expenses'), { name: n, amount: a, timestamp: Date.now() });
                document.getElementById('ledger-item-name').value = ''; document.getElementById('ledger-item-amount').value = '';
            } catch (e) {}
        };

        window.deleteExpense = async (id) => {
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'kansai-pro-2025';
            try { await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'expenses', id)); } catch (e) {}
        };

        function renderLedger() {
            const list = document.getElementById('ledger-list'); if (!list) return;
            const t = expenses.reduce((s, i) => s + i.amount, 0);
            document.getElementById('ledger-total-jpy').innerText = `¥ ${t.toLocaleString()}`;
            list.innerHTML = expenses.map(i => `<div class="flex justify-between items-center bg-white p-5 rounded-3xl shadow-sm border border-gray-100 font-bold fade-in"><div class="flex-1 font-black text-gray-800 font-mono text-left">${i.name}</div><div class="text-right flex items-center gap-4"><p class="text-lg text-[--kyoto-red] font-mono font-black">¥ ${i.amount.toLocaleString()}</p><button onclick="window.deleteExpense('${i.id}')" class="text-gray-300 transition px-2 text-left"><i class="fas fa-trash-alt text-xs"></i></button></div></div>`).join('');
        }

        window.onload = async () => {
            const nav = document.getElementById('day-nav-container'), dayNames = ["第一日", "第二日", "第三日", "第四日", "第五日", "第六日"];
            nav.innerHTML = dayNames.map((n, i) => `<button onclick="window.switchDay(${i+1})" id="tab${i+1}" class="px-8 py-3 rounded-[1.5rem] bg-white text-gray-400 shadow-sm border border-gray-100 font-black transition-all text-xs text-center">${n}</button>`).join('');
            try { window.switchDay(1); } catch (e) {}
            try {
                const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : { apiKey: "preview" };
                const app = initializeApp(firebaseConfig), auth = getAuth(app), db = getFirestore(app);
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'kansai-pro-2025';
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) { await signInWithCustomToken(auth, __initial_auth_token); } else { await signInAnonymously(auth); }
                onAuthStateChanged(auth, (u) => {
                    user = u; if (user) {
                        onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'expenses'), (snapshot) => {
                            expenses = snapshot.docs.map(d => ({ id: d.id, ...d.data() })).sort((a, b) => b.timestamp - a.timestamp);
                            if (document.getElementById('ledger-list')) renderLedger();
                        });
                    }
                });
                const rateRes = await fetch('https://open.er-api.com/v6/latest/JPY');
                if (rateRes.ok) { const rateData = await rateRes.json(); exchangeRate = rateData.rates.TWD; window.liveRateText = `1 JPY = ${exchangeRate.toFixed(3)} TWD`; }
            } catch (e) {}
        };
    </script>
</body>
</html>
